server {
    listen 3000 ; 
    server_name i.tshirt.xin; 
    index index.html index.php index.htm default.php default.htm default.html ; 
    access_log /www/sites/Habitify/log/access.log main; 
    error_log /www/sites/Habitify/log/error.log; 
    
    # 网站根目录
    root /www/sites/Habitify/index; 
    
    # 安全配置 - 阻止访问敏感文件
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md) {
        return 404; 
    }
    
    # Let's Encrypt验证
    location ^~ /.well-known {
        allow all; 
        root /usr/share/nginx/html; 
    }
    
    if ( $uri ~ "^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$" ) {
        return 403; 
    }
    
    # ================================
    # 新增：React单页应用路由处理
    # ================================
    location / {
        try_files $uri $uri/ /index.html;
        
        # 添加安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    }
    
    # ================================
    # 新增：静态资源优化
    # ================================
    # CSS和JS文件缓存
    location ~* \.(css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
    }
    
    # 图片文件缓存
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
    }
    
    # 字体文件缓存
    location ~* \.(woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
    }
    
    # ================================
    # 新增：Gzip压缩配置
    # ================================
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # ================================
    # 保持原有配置
    # ================================
    error_page 404 /404.html; 
    include /www/sites/Habitify/rewrite/Habitify.conf; 
}